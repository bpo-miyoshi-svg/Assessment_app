<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINOMI Smart Assess Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        
        /* å°åˆ·è¨­å®š: ãƒ¡ã‚¤ãƒ³ç”»é¢ã‹ã‚‰ç›´æ¥Ctrl+Pã•ã‚ŒãŸå ´åˆã®æœ€ä½é™ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body { display: none; } /* ã‚¢ãƒ—ãƒªç”»é¢ã¯å°åˆ·ã—ãªã„ */
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <div id="app-container" class="max-w-4xl mx-auto bg-white min-h-screen md:min-h-0 md:my-8 md:rounded-xl shadow-2xl overflow-hidden flex flex-col">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="bg-slate-800 text-white p-4 flex justify-between items-center sticky top-0 z-50 shadow-md">
            <div class="flex items-center gap-3">
                <i class="ph ph-plant text-3xl text-green-400"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">KINOMI <span class="font-normal text-slate-300 text-sm">Smart Assess Pro</span></h1>
                    <p class="text-[10px] text-slate-400">Professional Vocational Assessment Tool</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="clearData()" class="bg-slate-600 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 border border-slate-500">
                    <i class="ph ph-trash"></i> <span class="hidden md:inline">æ–°è¦ä½œæˆ</span>
                </button>
            </div>
        </header>

        <main class="flex-grow p-4 md:p-8 pb-24">
            
            <!-- ä¿å­˜çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ -->
            <div id="save-status" class="text-xs text-green-600 font-bold text-right mb-2 h-4 opacity-0 transition-opacity duration-500">
                <i class="ph ph-check-circle"></i> è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ
            </div>

            <!-- 1. åŸºæœ¬æƒ…å ±å…¥åŠ› -->
            <section id="section-basic" class="mb-8 border-b pb-8">
                <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-sm">Step 1</span> å¯¾è±¡è€…æƒ…å ±
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">æ°å</label>
                        <input type="text" id="userName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="æ°åã‚’å…¥åŠ›">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">ç”Ÿå¹´æœˆæ—¥</label>
                        <input type="date" id="userDob" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">è©•ä¾¡æ—¥</label>
                        <input type="date" id="assessDate" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">éšœå®³ç¨®åˆ¥/æ‰‹å¸³</label>
                        <input type="text" id="userDisability" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="ä¾‹ï¼šASD (æ‰‹å¸³2ç´š)">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 mb-1">å°±åŠ´å¸Œæœ›ãƒ»ãƒ‹ãƒ¼ã‚ºï¼ˆç°¡æ½”ã«ï¼‰</label>
                        <input type="text" id="userNeeds" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="ä¾‹ï¼šäº‹å‹™è·å¸Œæœ›ã€é€±20æ™‚é–“ç¨‹åº¦ã‹ã‚‰">
                    </div>
                    <div class="md:col-span-3">
                         <label class="block text-xs font-bold text-slate-500 mb-1">ç·åˆæ‰€è¦‹ãƒ»æ”¯æ´æ–¹é‡ï¼ˆãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼‰</label>
                        <textarea id="overallComment" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 bg-slate-50 h-20" placeholder="å…¨ä½“çš„ãªæ‰€è¦‹ã‚„ä»Šå¾Œã®æ”¯æ´æ–¹é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                </div>
            </section>

            <!-- 2. ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆå®Ÿæ–½ã‚¨ãƒªã‚¢ -->
            <section id="section-assessment">
                <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                    <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-sm">Step 2</span> è©•ä¾¡å®Ÿæ–½
                    </h2>
                    
                    <!-- ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– -->
                    <div class="flex bg-slate-100 p-1 rounded-lg w-full md:w-auto overflow-x-auto">
                        <button onclick="filterCategory('all')" class="flex-shrink-0 px-3 py-1 text-sm rounded-md font-bold transition bg-white shadow text-blue-600 cat-btn" id="btn-all">å…¨ã¦è¡¨ç¤º</button>
                        <button onclick="filterCategory('task')" class="flex-shrink-0 px-3 py-1 text-sm rounded-md font-medium text-slate-500 hover:bg-white/50 transition cat-btn" id="btn-task">ä½œæ¥­é‚è¡Œ</button>
                        <button onclick="filterCategory('life')" class="flex-shrink-0 px-3 py-1 text-sm rounded-md font-medium text-slate-500 hover:bg-white/50 transition cat-btn" id="btn-life">è·æ¥­ç”Ÿæ´»</button>
                        <button onclick="filterCategory('inter')" class="flex-shrink-0 px-3 py-1 text-sm rounded-md font-medium text-slate-500 hover:bg-white/50 transition cat-btn" id="btn-inter">å¯¾äººé–¢ä¿‚</button>
                    </div>
                </div>

                <!-- è©•ä¾¡é …ç›®ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
                <div id="items-container" class="space-y-6">
                    <!-- JavaScriptã§ã“ã“ã«é …ç›®ãŒç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
            </section>

            <!-- å®Œäº†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="mt-12 mb-8 p-6 bg-blue-50 border border-blue-200 rounded-xl text-center">
                <p class="text-blue-800 font-bold mb-4">å…¨ã¦ã®å…¥åŠ›ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ</p>
                <button onclick="openPreview()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2 mx-auto text-lg">
                    <i class="ph ph-file-pdf text-2xl"></i> è©•ä¾¡ã‚’çµ‚äº†ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
                </button>
                <p class="text-xs text-blue-400 mt-2">åˆ¥ã‚¿ãƒ–ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé–‹ãã€PDFä¿å­˜ãŒå¯èƒ½ã«ãªã‚Šã¾ã™</p>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆç”¨ã®éè¡¨ç¤ºã‚­ãƒ£ãƒ³ãƒã‚¹ -->
            <div style="position: absolute; left: -9999px;">
                <canvas id="hiddenRadarChart" width="400" height="400"></canvas>
            </div>

        </main>
    </div>

    <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        const STORAGE_KEY = 'kinomi_assess_data_v1';

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        const assessmentDB = [
            // â–  ä½œæ¥­é‚è¡Œ (Task Performance)
            { id: "æ¨-1", category: "task", type: "æ¨å¥¨", label: "æŒ‡ç¤ºã•ã‚ŒãŸæ‰‹é †ã«å¾“ã£ã¦ä½œæ¥­ã™ã‚‹", training: "ãƒ”ãƒƒã‚­ãƒ³ã‚°ã€å°å…¥ä½œæ¥­ãªã©ã®æ‰‹é †ãŒæ±ºã¾ã£ãŸèª²é¡Œ", criteria: { A: "æ‰‹é †é€šã‚Šã§ãã‚‹", B: "æŒ‡ç¤ºãŒã‚ã‚Œã°å¯", C: "å›°é›£" } },
            { id: "æ¨-2", category: "task", type: "æ¨å¥¨", label: "å®‰å…¨ã«ä½œæ¥­ã™ã‚‹", training: "ã‚«ãƒƒã‚¿ãƒ¼ä½¿ç”¨ä½œæ¥­ã€é‡é‡ç‰©é‹æ¬", criteria: { A: "å±é™ºè¡Œå‹•ãªã—", B: "æ³¨æ„ã§å¯", C: "å±é™ºè¡Œå‹•ã‚ã‚Š" } },
            { id: "æ¨-3", category: "task", type: "æ¨å¥¨", label: "æ™‚é–“å†…ã«ä»•äº‹ã‚’ä»•ä¸Šã’ã‚‹", training: "ç´æœŸã‚’è¨­å®šã—ãŸãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã€ä»•åˆ†ã‘", criteria: { A: "æ™‚é–“å†…å®Œäº†", B: "æ¦‚ã­å®Œäº†", C: "æœªå®Œäº†" } },
            { id: "é¸-1", category: "task", type: "é¸æŠ", label: "æ­£ç¢ºã«ä½œæ¥­ã™ã‚‹", training: "æ¤œå“ä½œæ¥­ã€æ•°å€¤ãƒã‚§ãƒƒã‚¯", criteria: { A: "ãƒŸã‚¹ã»ã¼ãªã—", B: "æ™‚ã€…ãƒŸã‚¹ã‚ã‚Š", C: "ãƒŸã‚¹å¤šã„" } },
            { id: "é¸-5", category: "task", type: "é¸æŠ", label: "é›†ä¸­ã—ã¦ä½œæ¥­ã™ã‚‹", training: "2æ™‚é–“ç¨‹åº¦ã®ç¶™ç¶šä½œæ¥­", criteria: { A: "2æ™‚é–“é›†ä¸­", B: "1æ™‚é–“ç¨‹åº¦", C: "ç¶šã‹ãªã„" } },
            { id: "é¸-6", category: "task", type: "é¸æŠ", label: "å¤‰æ›´ã«å¯¾å¿œã™ã‚‹", training: "ä½œæ¥­é€”ä¸­ã§ä»•æ§˜å¤‰æ›´ã‚’æŒ‡ç¤ºã™ã‚‹", criteria: { A: "å¯¾å¿œå¯", B: "æŒ‡ç¤ºã§å¯", C: "ãƒ‘ãƒ‹ãƒƒã‚¯/ä¸å¯" } },
            { id: "é¸-13", category: "task", type: "é¸æŠ", label: "ãƒ¡ãƒ¢ã‚’å–ã£ã¦æ´»ç”¨ã™ã‚‹", training: "å£é ­æŒ‡ç¤ºã®ã¿ã®ä½œæ¥­", criteria: { A: "æ´»ç”¨ã§ãã‚‹", B: "ä¸ååˆ†", C: "å–ã‚‰ãªã„" } },
            // â–  è·æ¥­ç”Ÿæ´» (Vocational Life)
            { id: "æ¨-4", category: "life", type: "æ¨å¥¨", label: "è·å ´ã®è¦å‰‡ã‚’å®ˆã‚‹", training: "æ¨¡æ“¬è·å ´ã§ã®å°±æ¥­è¦å‰‡éµå®ˆ", criteria: { A: "éµå®ˆã—ã¦ã„ã‚‹", B: "æ¦‚ã­å¯", C: "å®ˆã‚Œãªã„" } },
            { id: "æ¨-5", category: "life", type: "æ¨å¥¨", label: "å‹¤æ€ ã®å®‰å®šï¼ˆé…åˆ»ãƒ»æ¬ å‹¤ï¼‰", training: "é€šæ‰€å®Ÿç¸¾ã®ç¢ºèª", criteria: { A: "å®‰å®š", B: "æœˆ1å›ç¨‹åº¦", C: "é€±1å›ä»¥ä¸Š" } },
            { id: "æ¨-8", category: "life", type: "æ¨å¥¨", label: "èº«ã ã—ãªã¿ã‚’æ•´ãˆã‚‹", training: "æ¯æœã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèª", criteria: { A: "æ¸…æ½”", B: "æ™‚ã€…ä¸å‚™", C: "ä¸å‚™å¤šã„" } },
            { id: "é¸-24", category: "life", type: "é¸æŠ", label: "é€šé™¢ãƒ»æœè–¬ç®¡ç†", training: "æœè–¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¢ºèªã€æ—¥å ±", criteria: { A: "è‡ªå·±ç®¡ç†", B: "è¦æ”¯æ´", C: "è¦ä»‹åŠ©" } },
            // â–  å¯¾äººé–¢ä¿‚ (Interpersonal)
            { id: "æ¨-12", category: "inter", type: "æ¨å¥¨", label: "æŒ¨æ‹¶ã‚„è¿”äº‹ã‚’ã™ã‚‹", training: "æœç¤¼ã€å…¥é€€å®¤æ™‚ã®è¡Œå‹•è¦³å¯Ÿ", criteria: { A: "è‡ªç™ºçš„", B: "å—å‹•çš„", C: "ä¸å¯" } },
            { id: "æ¨-16", category: "inter", type: "æ¨å¥¨", label: "å ±å‘Šãƒ»é€£çµ¡ãƒ»ç›¸è«‡", training: "ä½œæ¥­å®Œäº†å ±å‘Šã€ãƒˆãƒ©ãƒ–ãƒ«å ±å‘Šèª²é¡Œ", criteria: { A: "é©åˆ‡", B: "æ™‚ã€…ä¸è¶³", C: "ä¸è¶³" } },
            { id: "æ¨-17", category: "inter", type: "æ¨å¥¨", label: "æ„Ÿæƒ…ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹", training: "æŒ‡æ‘˜ã‚’å—ã‘ãŸæ™‚ã®åå¿œè¦³å¯Ÿ", criteria: { A: "å®‰å®š", B: "æ™‚ã€…è¡¨å‡º", C: "ä¸å®‰å®š" } },
            { id: "é¸-27", category: "inter", type: "é¸æŠ", label: "ä»–ã®äººã¨å”åŠ›ã—ã¦ä½œæ¥­ã™ã‚‹", training: "ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¯ãƒ¼ã‚¯ã€å…±åŒä½œæ¥­", criteria: { A: "å½¹å‰²é‚è¡Œ", B: "æ™‚ã€…ä¸å¯", C: "éå”åŠ›çš„" } }
        ];

        let state = { category: 'all', assessments: {} };
        let radarChart = null;

        function init() {
            loadData();
            renderItems();
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', () => { saveData(); updateHiddenChart(); });
            });
            setTimeout(updateHiddenChart, 500);
        }

        function saveData() {
            const dataToSave = {
                assessments: state.assessments,
                basicInfo: {
                    name: document.getElementById('userName').value,
                    dob: document.getElementById('userDob').value,
                    date: document.getElementById('assessDate').value,
                    disability: document.getElementById('userDisability').value,
                    needs: document.getElementById('userNeeds').value,
                    comment: document.getElementById('overallComment').value
                }
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            const statusEl = document.getElementById('save-status');
            statusEl.classList.remove('opacity-0');
            setTimeout(() => statusEl.classList.add('opacity-0'), 2000);
        }

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.basicInfo) {
                        document.getElementById('userName').value = parsed.basicInfo.name || '';
                        document.getElementById('userDob').value = parsed.basicInfo.dob || '';
                        document.getElementById('assessDate').value = parsed.basicInfo.date || '';
                        document.getElementById('userDisability').value = parsed.basicInfo.disability || '';
                        document.getElementById('userNeeds').value = parsed.basicInfo.needs || '';
                        document.getElementById('overallComment').value = parsed.basicInfo.comment || '';
                    }
                    if (parsed.assessments) state.assessments = parsed.assessments;
                } catch (e) { console.error("Error loading data", e); }
            } else {
                document.getElementById('assessDate').valueAsDate = new Date();
            }
        }

        function clearData() {
            if (confirm("å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦æ¶ˆå»ã—ã€æ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function filterCategory(cat) {
            state.category = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.className = "flex-shrink-0 px-3 py-1 text-sm rounded-md font-medium text-slate-500 hover:bg-white/50 transition cat-btn");
            document.getElementById(`btn-${cat}`).className = "flex-shrink-0 px-3 py-1 text-sm rounded-md font-bold transition bg-white shadow text-blue-600 cat-btn";
            renderItems();
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';
            const filtered = assessmentDB.filter(item => state.category === 'all' ? true : item.category === state.category);

            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white border rounded-xl p-4 md:p-6 hover:shadow-md transition group";
                let badgeColor = item.category === 'task' ? "bg-green-100 text-green-700" : (item.category === 'life' ? "bg-orange-100 text-orange-700" : "bg-purple-100 text-purple-700");
                const data = state.assessments[item.id] || { score: "", note: "" };

                card.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-start gap-4">
                        <div class="flex-grow">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="${badgeColor} text-xs font-bold px-2 py-1 rounded">${item.id}</span>
                                <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">${item.type}</span>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800 mb-2">${item.label}</h3>
                            <div class="bg-blue-50 border border-blue-100 rounded-lg p-2 text-xs mb-3 text-blue-900">
                                <i class="ph ph-magnifying-glass"></i> ${item.training}
                            </div>
                            <div class="text-xs text-slate-500 flex gap-4">
                                <span>A: ${item.criteria.A}</span>
                                <span>B: ${item.criteria.B}</span>
                                <span>C: ${item.criteria.C}</span>
                            </div>
                        </div>
                        <div class="md:w-64 flex-shrink-0 bg-slate-50 p-3 rounded-lg">
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <button onclick="setScore('${item.id}', 'A')" class="${getScoreClass(item.id, 'A')} py-2 rounded font-bold border text-sm transition">A</button>
                                <button onclick="setScore('${item.id}', 'B')" class="${getScoreClass(item.id, 'B')} py-2 rounded font-bold border text-sm transition">B</button>
                                <button onclick="setScore('${item.id}', 'C')" class="${getScoreClass(item.id, 'C')} py-2 rounded font-bold border text-sm transition">C</button>
                            </div>
                            <textarea oninput="setNote('${item.id}', this.value)" class="w-full text-xs p-2 border rounded h-16" placeholder="è¦³å¯Ÿãƒ¡ãƒ¢">${data.note}</textarea>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        function setScore(id, score) {
            if (!state.assessments[id]) state.assessments[id] = { note: "" };
            state.assessments[id].score = score;
            saveData();
            renderItems();
            updateHiddenChart();
        }

        function setNote(id, note) {
            if (!state.assessments[id]) state.assessments[id] = { score: "" };
            state.assessments[id].note = note;
            saveData();
        }

        function getScoreClass(id, target) {
            const current = state.assessments[id]?.score;
            if (current === target) {
                if (target === 'A') return "bg-blue-600 text-white border-blue-600 shadow";
                if (target === 'B') return "bg-yellow-500 text-white border-yellow-500 shadow";
                if (target === 'C') return "bg-red-500 text-white border-red-500 shadow";
            }
            return "bg-white text-slate-400 border-slate-200 hover:bg-slate-100";
        }

        function updateHiddenChart() {
            const ctx = document.getElementById('hiddenRadarChart').getContext('2d');
            const scores = { task: [], life: [], inter: [] };
            
            assessmentDB.forEach(item => {
                const val = state.assessments[item.id]?.score;
                let point = 0;
                if (val === 'A') point = 3; else if (val === 'B') point = 2; else if (val === 'C') point = 1;
                if (point > 0) scores[item.category].push(point);
            });

            const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : 0;
            
            if (radarChart) radarChart.destroy();

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ä½œæ¥­é‚è¡Œèƒ½åŠ›', 'è·æ¥­ç”Ÿæ´»å®‰å®šæ€§', 'å¯¾äººæŠ€èƒ½'],
                    datasets: [{
                        label: 'è©•ä¾¡ã‚¹ã‚³ã‚¢',
                        data: [avg(scores.task), avg(scores.life), avg(scores.inter)],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    animation: false, // å°åˆ·ç”¨ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
                    scales: {
                        r: {
                            min: 0, max: 3,
                            ticks: { stepSize: 1, callback: v => v===1?'C':(v===2?'B':(v===3?'A':'')) }
                        }
                    }
                }
            });
        }

        // â– â– â–  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ & PDFå‡ºåŠ›ãƒ­ã‚¸ãƒƒã‚¯ â– â– â– 
        function openPreview() {
            // 1. ãƒãƒ£ãƒ¼ãƒˆç”»åƒã®ç”Ÿæˆ
            const chartCanvas = document.getElementById('hiddenRadarChart');
            const chartImgUrl = chartCanvas.toDataURL('image/png');

            // 2. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            const name = document.getElementById('userName').value || "æœªå…¥åŠ›";
            const date = document.getElementById('assessDate').value;
            const dob = document.getElementById('userDob').value;
            const disability = document.getElementById('userDisability').value;
            const needs = document.getElementById('userNeeds').value;
            const overall = document.getElementById('overallComment').value;

            // 3. è©•ä¾¡é …ç›®ã®HTMLç”Ÿæˆï¼ˆ2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ï¼‰
            let itemsHtml = '';
            assessmentDB.forEach(item => {
                const data = state.assessments[item.id];
                if (data && data.score) {
                    let badge = "";
                    if (data.score === 'A') badge = `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-bold border border-blue-200">A: è‡ªç«‹</span>`;
                    else if (data.score === 'B') badge = `<span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold border border-yellow-200">B: è¦é…æ…®</span>`;
                    else if (data.score === 'C') badge = `<span class="inline-block bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs font-bold border border-red-200">C: å›°é›£</span>`;

                    itemsHtml += `
                        <div class="border-b border-gray-200 pb-2 break-inside-avoid">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-gray-500">${item.id} ${item.label}</span>
                                ${badge}
                            </div>
                            <p class="text-[10px] text-gray-600 leading-tight">
                                <span class="font-semibold">è¦³å¯Ÿ:</span> ${data.note || "ç‰¹ã«ãªã—"}
                            </p>
                        </div>
                    `;
                }
            });

            // 4. æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç”¨HTMLã®æ§‹ç¯‰
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <title>KINOMI ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆ - ${name}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
                        body { font-family: 'Noto Sans JP', sans-serif; -webkit-print-color-adjust: exact; background: #555; }
                        .paper { width: 210mm; min-height: 297mm; background: white; margin: 20px auto; padding: 15mm; box-shadow: 0 0 10px rgba(0,0,0,0.3); box-sizing: border-box; }
                        @media print {
                            body { background: white; margin: 0; }
                            .paper { width: 100%; box-shadow: none; margin: 0; padding: 0; }
                            .no-print { display: none !important; }
                            @page { size: A4; margin: 15mm; }
                        }
                        .grid-items { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; column-gap: 30px; }
                    </style>
                </head>
                <body>
                    <div class="no-print fixed top-0 left-0 w-full bg-slate-800 text-white p-4 flex justify-between items-center shadow-lg z-50">
                        <span class="font-bold text-lg">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢</span>
                        <div>
                            <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded font-bold mr-4 transition">ğŸ–¨ PDFä¿å­˜ / å°åˆ·</button>
                            <button onclick="window.close()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>

                    <div class="paper mt-20 print:mt-0">
                        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                        <div class="border-b-4 border-green-600 pb-4 mb-6 flex justify-between items-end">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800 tracking-wider">KINOMI <span class="text-lg font-normal text-gray-500">Assessment Report</span></h1>
                                <p class="text-xs text-gray-400">è·æ¥­æº–å‚™æ€§ç·åˆè©•ä¾¡ã‚·ãƒ¼ãƒˆ</p>
                            </div>
                            <div class="text-right text-sm">
                                <p>ä½œæˆæ—¥: ${new Date().toLocaleDateString('ja-JP')}</p>
                            </div>
                        </div>

                        <!-- åŸºæœ¬æƒ…å ± -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6 flex justify-between items-start border border-gray-100">
                            <div class="w-2/3">
                                <div class="flex gap-6 mb-2">
                                    <div><span class="text-xs text-gray-400 block">æ°å</span><span class="font-bold text-lg">${name}</span></div>
                                    <div><span class="text-xs text-gray-400 block">ç”Ÿå¹´æœˆæ—¥</span><span class="font-bold">${dob}</span></div>
                                    <div><span class="text-xs text-gray-400 block">éšœå®³ç¨®åˆ¥</span><span class="font-bold">${disability}</span></div>
                                </div>
                                <div><span class="text-xs text-gray-400 block">å°±åŠ´ãƒ‹ãƒ¼ã‚º</span><span class="text-sm">${needs}</span></div>
                            </div>
                            <div class="w-1/3 flex justify-center items-center">
                                <!-- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç”»åƒ -->
                                <img src="${chartImgUrl}" style="max-height: 120px; width: auto;">
                            </div>
                        </div>

                        <!-- ç·åˆæ‰€è¦‹ -->
                        <div class="mb-6">
                            <h3 class="font-bold text-sm bg-gray-200 px-2 py-1 mb-2 border-l-4 border-gray-600">ç·åˆæ‰€è¦‹ãƒ»ä»Šå¾Œã®æ”¯æ´æ–¹é‡</h3>
                            <div class="text-sm p-2 border border-gray-200 rounded bg-white min-h-[80px] whitespace-pre-wrap">${overall}</div>
                        </div>

                        <!-- è©•ä¾¡è©³ç´°ï¼ˆ2åˆ—ã‚°ãƒªãƒƒãƒ‰ï¼‰ -->
                        <h3 class="font-bold text-sm bg-blue-100 text-blue-800 px-2 py-1 mb-4 border-l-4 border-blue-600">è©•ä¾¡è©³ç´°</h3>
                        <div class="grid-items text-sm">
                            ${itemsHtml}
                        </div>
                        
                        <div class="mt-8 pt-4 border-t text-center text-[10px] text-gray-400">
                            Generated by KINOMI Smart Assess Pro
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // èµ·å‹•
        init();
    </script>
</body>
</html>
